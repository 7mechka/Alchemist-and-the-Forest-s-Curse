define text_list = {
    'room 1': {
        'stage 1': [
            'Вы входите в лес. Тяжелые лучи солнца пробиваются сквозь густую листву, создавая причудливые тени на земле.',
            'В воздухе витает запах свежести и зелени. Вы чувствуете, что это место полное тайн и ингредиентов.',
            'Продолжая бродить по лесу, вы встречаете ингредиенты тут и там, но их достаточно мало.',
            'Может, не стоит собирать их всех сейчас?'
        ],
        'stage 2': [
            'Вы входите в лес. Тяжелые лучи солнца пробиваются сквозь густую листву, создавая причудливые тени на земле.',
            'Следуя по тропам, вы высматриваете ингредиенты и что-то ещё интересное.',
            'В этой части леса редко когда бывает много ингредиентов, но кое какие всё равно встречаются.',
            'Если вы не будете спешить, то сможете найти больше завтра.'
        ],
        'stage 3': [
            'Вы входите в лес. Тяжелые лучи солнца пробиваются сквозь густую листву, создавая причудливые тени на земле.',
            'Уже на входе в лес вы замечаете, что здесь много ингредиентов.',
            'Даже не сильно углубляясь, вы находите достаточно много интересных растений и грибов.',
            'Может, если ещё немного подождать, то ингредиентов станет ещё больше?.'
        ],
        'stage 4': [
            'Вы входите в лес. Тяжелые лучи солнца пробиваются сквозь густую листву, создавая причудливые тени на земле.',
            'Не успели вы войти в лес, как сразу же заметили, что здесь много ингредиентов.',
            'Кажеться, что в этом лесу вы сможете найти всё, что вам нужно для зелий, и даже больше.',
            'Учитывая количество ингредиентов, наврятли завтра их станет больше. Самое время для сбора.'
        ]
    },
    'room 2': {
        'stage 1': [
            'Углубляясь в лес, вы замечаете, что здесь тихо и спокойно.',
            'Протоптаные тропинки местных жителей редеют, и вы чувствуете себя одиноким углубляясь в чащу.',
            'Здесь тоже встречаются ингредиенты, но их не так много, как хотелось бы.',
            'Может, не стоит собирать их всех сейчас?'
        ],
        'stage 2': [
            'Углубляясь в лес, вы замечаете, что здесь тихо и спокойно.',
            'Ступая скорее по мягкой траве, чем по тропинкам, вы чувствуете себя одиноким.',
            'Тут и там встречаются ингредиенты, их больше чем обычно, но всё ещё не так много.',
            'Возможно, если вы подождёте, то завтра их станет больше.'
        ],
        'stage 3': [
            'Углубляясь в лес, вы замечаете, что здесь тихо и спокойно.',
            'Продвигаясь дальше, вы пытаетесь не сбиться с пути с этими плохими тропинками.',
            'Ингредиенты видны невооружённым глазом, будто после дождя.',
            'Скорее всего, если вы подождёте, то завтра их станет ещё больше.'
        ],
        'stage 4': [
            'Углубляясь в лес, вы замечаете, что здесь тихо и спокойно.',
            'Своими частыми визитами, возможно, вы уже успели запомнить все тропинки.',
            'Всюду, куда бы вы ни посмотрели, видны ингредиенты.',
            'Со всеми этими травами, которые везде, новым просто не будет куда расти. Можно смело собирать.',
        ]
    },
    'room 3': {
        'stage 1': [
            'Продвигаясь всё глубже, вы покидаете знакомые тропинки, и выходите в длинную поляну.',
            'Здешняя трава мягкая и густая, а деревья высокие и раскидистые.',
            'Хотя это и рай для роста, но ингредиентов здесь не так много.',
            'Учитывая это, вы можете не собирать их все сейчас.',
        ],
        'stage 2': [
            'Продвигаясь всё глубже, вы покидаете знакомые тропинки, и выходите в длинную поляну.',
            'Отделенное от остального леса, это место кажется спокойным и умиротворяющим.',
            'Здесь много трав и грибов, но всё ещё не так много, как хотелось бы.',
            'Стоит ли ждать завтра, чтобы собрать больше?',
        ],
        'stage 3': [
            'Продвигаясь всё глубже, вы покидаете знакомые тропинки, и выходите в длинную поляну.',
            'Здесь тихо и спокойно, и вы чувствуете себя в безопасности.',
            'Ингредиентов прибавилось, и вы можете найти много интересных растений и грибов.',
            'Очевидно что это ещё не максимум, и если вы подождёте, то завтра их станет ещё больше.',
        ],
        'stage 4': [
            'Продвигаясь всё глубже, вы покидаете знакомые тропинки, и выходите в длинную поляну.',
            'Большие кроны деревьев создают уютную тень, а мягкая трава приятно щекочет ноги.',
            'Кажеться, что вся поляна покрыта ингредиентами, и вы можете найти всё, что вам нужно.',
            'Даже если вы подождёте, то завтра их не больше.',
        ],
    },
    'room 4': {
        'stage 1': [
            'Вы нашли секретный уголок леса, где природа царит в полном объёме.',
            'Здесь высокие деревья, густая трава и множество цветов.',
            'Ингредиентов здесь не так много, как хотелось бы.',
            'Может, не стоит собирать их всех сейчас?',
        ],
        'stage 2': [
            'Вы нашли секретный уголок леса, где природа царит в полном объёме.',
            'Воздух здесь свежий, а звуки природы успокаивают.',
            'Здесь много трав и грибов, но всё ещё не так много, как хотелось бы.',
            'Возможно, если вы подождёте, то завтра их станет больше.',
        ],
        'stage 3': [
            'Вы нашли секретный уголок леса, где природа царит в полном объёме.',
            'Трава здесь мягкая, а деревья высокие и раскидистые.',
            'Изобилие ингредиентов поражает воображение, и вы можете найти много интересных растений и грибов.',
            'Очевидно что это ещё не максимум, и если вы подождёте, то завтра их станет ещё больше.',
        ],
        'stage 4': [
            'Вы нашли секретный уголок леса, где природа царит в полном объёме.',
            'Здешняя природа кажется нетронутой, и вы чувствуете себя в гармонии с окружающим миром.',
            'Кажетсья что все растения и грибы здесь растут в изобилии, и вы можете найти всё, что вам нужно.',
            'Даже если вы подождёте, то завтра их не станет больше.',
        ]
    }
}

default forest_stages = [0, 0, 0, 0]
default default_forest_room_list = [[], [], [], []]
default forest_room_list = [[], [], [], []]
define room = 1  # Текущая комната леса


init python:
    import copy

    from random import randint, choice, random

    # Генерация ингредиентов
    def generate_ingredients(stage=1):
        """
        Генерирует список ингредиентов в зависимости от стадии леса.
        """

        ingredients = []

        random_limit = randint(stage*2, stage*2+2)  # Увеличиваем количество ингредиентов в зависимости от стадии

        for i in range(random_limit):
                rarity = get_rarity()
                if rarity <= 5:
                    rarity_list = []
                    for item in itemList:
                        if item['type'] == 'ingredient' and item['rarity'] == 'legendary':
                            rarity_list.append(item.copy())
                    if rarity_list:
                        ingredients.append(choice(rarity_list))
                elif rarity <= 10:
                    rarity_list = []
                    for item in itemList:
                        if item['type'] == 'ingredient' and item['rarity'] == 'epic':
                            rarity_list.append(item.copy())
                    if rarity_list:
                        ingredients.append(choice(rarity_list))
                elif rarity <= 30:
                    rarity_list = []
                    for item in itemList:
                        if item['type'] == 'ingredient' and item['rarity'] == 'rare':
                            rarity_list.append(item.copy())
                    if rarity_list:
                        ingredients.append(choice(rarity_list))
                elif rarity <= 150:
                    rarity_list = []
                    for item in itemList:
                        if item['type'] == 'ingredient' and item['rarity'] == 'uncommon':
                            rarity_list.append(item.copy())
                    if rarity_list:
                        ingredients.append(choice(rarity_list))
                elif rarity <= 800:
                    rarity_list = []
                    for item in itemList:
                        if item['type'] == 'ingredient' and item['rarity'] == 'common':
                            rarity_list.append(item.copy())
                    if rarity_list:
                        ingredients.append(choice(rarity_list))
        if len(ingredients) < random_limit:
            rarity_list = []
            for item in itemList:
                if item['type'] == 'ingredient' and item['rarity'] == 'common':
                    rarity_list.append(item.copy())
            if rarity_list:
                ingredients.append(choice(rarity_list))

        return ingredients

    # Генерация ингредиентов с позицией
    def generate_ingredients_with_positions(stage=1):
        ingredients = generate_ingredients(stage) 
        for item in ingredients:
            item["pos_x"] = round(0.05 + random() * (0.95 - 0.05), 3)
            item["pos_y"] = round(0.7 + random() * (0.9 - 0.7), 3)
        return ingredients

    #  Генерация редкости предмета
    def get_rarity():
        return randint(1, 1000)

    #  Генерация ингредиентов на все комнаты леса
    def generate_rooms_ingredients():
        global forest_stages, forest_room_list, default_forest_room_list
        for i in range(4):
            default_forest_room_list.append(generate_ingredients_with_positions(forest_stages[i]))
        default_forest_room_list = default_forest_room_list[-4:]  # Ограничиваем до 4 комнат
        forest_room_list = copy.deepcopy(default_forest_room_list)  # Глубокая копия

    # Перерасчёт стадий леса
    def calculating_stages():
        global forest_stages, forest_room_list, default_forest_room_list
        for i in range(len(forest_room_list)):
            if forest_stages[i] == 0:
                forest_stages[i] += 1 # Если стадия леса 0, то увеличиваем её до 1
                continue
            # Если в комнате леса количество ингредентов 0, и при этом это 4 стадия, то стадия сбрасывается в 1
            elif len(forest_room_list[i]) <= 0 and forest_stages[i] == 4:
                forest_stages[i] = 1
            # Если в комнате леса количество ингредиентов то же, что и в дефолтном списке, то стадия увеличивается
            if len(forest_room_list[i]) == len(default_forest_room_list[i]):
                if forest_stages[i] < 4:
                    forest_stages[i] += 1
            # Если в комнате леса количество ингредиентов меньше не более чем на 30%, чем в дефолтном списке, то стадия не меняется
            elif len(forest_room_list[i]) >= len(default_forest_room_list[i]) * 0.7:
                pass
            # Если в комнате леса количество ингредиентов меньше на более чем 30%, чем в дефолтном списке, то стадия уменьшается
            elif len(forest_room_list[i]) < len(default_forest_room_list[i]) * 0.7:
                if forest_stages[i] > 1:
                    forest_stages[i] -= 1 

screen forest_gui_screen(room = 1):
    zorder 100
    
    for i in forest_room_list[room-1]:
        imagebutton:
            idle i['icon']
            hover i['icon_hover']
            action [
                RemoveFromSet(forest_room_list[room-1], i),  # Удаляем предмет из списка
                Function(
                    add_item_to_inventory, 
                    item_id=i['id'], 
                    target_inventory=inventory,
                ),
                Function(add_notification, f"Вы собрали: {i['name']}"),
            ]
            tooltip i['description']
            xalign i["pos_x"]
            yalign i["pos_y"]
            xsize 180
            ysize 180

label forest_handler():
    # 1. Отображение сцены (Фон)
    if room == 1:
        show forest 1 with fade
    elif room == 2:
        show forest 2 with fade
    elif room == 3:
        show forest 3 with fade
    elif room == 4:
        show forest 4 with fade

    # 2. Отображение текста
    call forest_label(room)
    
    # 3. Отображение GUI (показ экрана сбора ингредиентов)
    show screen forest_gui_screen(room)
    
    # 4. Меню навигации (Итеративный цикл)
    menu:
        # Продвижение вглубь леса (jump для перехода)
        "Пойти вглудь леса" if room < 4:
            hide screen forest_gui_screen
            $ room += 1
            jump forest_handler
            
        # Вернуться в город (Полный выход)
        "Вернуться в город" if room == 1:
            # Скрываем GUI леса 
            hide screen forest_gui_screen
            call hide_gui # (Если это функция, скрывающая другие элементы GUI)
            scene black with fade
            
            # Вызов экрана карты или переход на метку, управляющую картой.
            call screen map() 
            
            # Единственный return, завершающий исходный call.
            return
            
        # Вернуться назад (jump для перехода)
        "Вернуться назад" if room > 1:
            hide screen forest_gui_screen
            $ room -= 1
            jump forest_handler
            
    return # Этот return будет достигнут только после выхода из menu

label forest_label(room=1):
    $ text = text_list['room ' + str(room)]['stage ' + str(forest_stages[room - 1])]
    "[text[0]]"
    "[text[1]]"
    "[text[2]]"
    "[text[3]]"
    return
    